name: TV EPG

on:
Â  push:
Â  Â  paths:
Â  Â  Â  - 'm_playlist.m3u8'
Â  Â  Â  - 'd_playlist.m3u8'
Â  schedule:
Â  Â  - cron: '0 11 * * *'Â  Â  # 12 pm CET / 1 pm CEST
Â  workflow_dispatch:
Â  Â  inputs:
Â  Â  Â  no_dashboard:
Â  Â  Â  Â  description: 'No dashboard commit'
Â  Â  Â  Â  type: boolean
Â  Â  Â  Â  default: false

permissions:
Â  contents: write
Â  pages: write
Â  id-token: write

concurrency:
Â  group: epg-pages
Â  cancel-in-progress: true

jobs:
Â  build_epg:
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.no_dashboard != 'true')) }}
Â  Â  runs-on: ubuntu-latest
Â  Â  timeout-minutes: 35
Â  Â  env:
Â  Â  Â  PER_SITE_JOBS: "10"
Â  Â  steps:
Â  Â  Â  - name: Checkout
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: Clone iptv-org/epg
Â  Â  Â  Â  run: git clone --depth 1 https://github.com/iptv-org/epg.git

Â  Â  Â  - name: Setup Node
Â  Â  Â  Â  uses: actions/setup-node@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  node-version: "22"
Â  Â  Â  Â  Â  cache: "npm"
Â  Â  Â  Â  Â  cache-dependency-path: epg/package-lock.json

Â  Â  Â  - name: Build EPG
Â  Â  Â  Â  shell: bash
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  PIPELINE: |
Â  Â  Â  Â  Â  Â  #!/usr/bin/env bash
Â  Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  Â  OUTDIR="${OUTDIR:-$RUNNER_TEMP}"; export OUTDIR

Â  Â  Â  Â  Â  Â  echo "::group::Install"
Â  Â  Â  Â  Â  Â  pushd epg >/dev/null
Â  Â  Â  Â  Â  Â  npm ci --no-audit --no-fund --silent
Â  Â  Â  Â  Â  Â  popd >/dev/null
Â  Â  Â  Â  Â  Â  echo "::endgroup::"

Â  Â  Â  Â  Â  Â  echo "::group::Prepare"
Â  Â  Â  Â  Â  Â  test -s "${GITHUB_WORKSPACE}/m_channels.xml"
Â  Â  Â  Â  Â  Â  test -s "${GITHUB_WORKSPACE}/d_channels.xml"
Â  Â  Â  Â  Â  Â  python - << 'PY'
Â  Â  Â  Â  Â  Â  import os, xml.etree.ElementTree as ET
Â  Â  Â  Â  Â  Â  gw, outdir = os.environ["GITHUB_WORKSPACE"], os.environ["OUTDIR"]
Â  Â  Â  Â  Â  Â  def split_by_site(src, prefix):
Â  Â  Â  Â  Â  Â  Â  Â  r = ET.parse(src).getroot()
Â  Â  Â  Â  Â  Â  Â  Â  groups = {}
Â  Â  Â  Â  Â  Â  Â  Â  for ch in r.findall('channel'):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s = (ch.get('site') or '').strip().lower()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if s:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groups.setdefault(s, []).append(ch)
Â  Â  Â  Â  Â  Â  Â  Â  for site, items in groups.items():
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  root = ET.Element('channels')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for ch in items:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  root.append(ch)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ET.indent(root, space="Â  ", level=0)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  except:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pass
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ET.ElementTree(root).write(os.path.join(outdir, f"{prefix}__{site}.channels.xml"),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â encoding='utf-8', xml_declaration=True)
Â  Â  Â  Â  Â  Â  split_by_site(os.path.join(gw, 'm_channels.xml'), '_main')
Â  Â  Â  Â  Â  Â  split_by_site(os.path.join(gw, 'd_channels.xml'), '_d')
Â  Â  Â  Â  Â  Â  PY
Â  Â  Â  Â  Â  Â  echo "::endgroup::"

Â  Â  Â  Â  Â  Â  cat > "${RUNNER_TEMP}/helpers.sh" <<'BASH'
Â  Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  Â  tune_params(){ local s="$1" maxc=6 tout=45000; case "$s" in
Â  Â  Â  Â  Â  Â  Â  raiplay.it) maxc=8; tout=45000;;
Â  Â  Â  Â  Â  Â  Â  mediasetinfinity.mediaset.it) maxc=10; tout=40000;;
Â  Â  Â  Â  Â  Â  Â  guidatv.sky.it) maxc=6; tout=45000;;
Â  Â  Â  Â  Â  Â  Â  tvpassport.com) maxc=6; tout=45000;;
Â  Â  Â  Â  Â  Â  Â  tivu.tv|guida.tv) maxc=3; tout=70000;;
Â  Â  Â  Â  Â  Â  esac; echo "$maxc $tout"; }
Â  Â  Â  Â  Â  Â  filter_log(){ awk '/^\s*info\s+\[[0-9]+\/[0-9]+\].*\([0-9]+ programs\)/||/saving to/||/^\s*success\s+done/'; }
Â  Â  Â  Â  Â  Â  throttle(){ local lim="${PER_SITE_JOBS:-10}"; while [ "$(jobs -rp | wc -l)" -ge "$lim" ]; do wait -n || true; done; }
Â  Â  Â  Â  Â  Â  retry_grab(){ local ch="$1" site="$2" out="$3" maxc="$4" tout="$5"
Â  Â  Â  Â  Â  Â  Â  echo "Grab $site -> $out (maxc=$maxc timeout=${tout}ms)"
Â  Â  Â  Â  Â  Â  Â  try(){ npm run grab -- --channels="$ch" --days=7 --maxConnections="$maxc" --timeout="$tout" --output="$out" | filter_log; }
Â  Â  Â  Â  Â  Â  Â  (try) || (sleep 2 && try) || (sleep 4 && try) || return 1; }
Â  Â  Â  Â  Â  Â  run_block(){ local prefix="$1" outdir="$2"
Â  Â  Â  Â  Â  Â  Â  shopt -s nullglob
Â  Â  Â  Â  Â  Â  Â  for f in "${OUTDIR}/${prefix}__"*.channels.xml; do
Â  Â  Â  Â  Â  Â  Â  Â  [ -s "$f" ] || continue
Â  Â  Â  Â  Â  Â  Â  Â  grep -q '<channel' "$f" || continue
Â  Â  Â  Â  Â  Â  Â  Â  local site="$(basename "$f")"; site="${site#${prefix}__}"; site="${site%.channels.xml}"
Â  Â  Â  Â  Â  Â  Â  Â  read MAXC TOUT < <(tune_params "$site")
Â  Â  Â  Â  Â  Â  Â  Â  local out="${outdir}/${prefix}__${site}.xml"
Â  Â  Â  Â  Â  Â  Â  Â  throttle; (
Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "> ${prefix#_} $site : $(grep -o '<channel[ >]' "$f" | wc -l) channels"
Â  Â  Â  Â  Â  Â  Â  Â  Â  if retry_grab "$f" "$site" "$out" "$MAXC" "$TOUT"; then
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "OK ${prefix#_} $site -> $out"
Â  Â  Â  Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "FAIL ${prefix#_} $site"; : > "$out"
Â  Â  Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  Â  Â  ) &
Â  Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â  Â  wait || true
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  BASH

Â  Â  Â  Â  Â  Â  echo "::group::Grab"
Â  Â  Â  Â  Â  Â  pushd epg >/dev/null
Â  Â  Â  Â  Â  Â  source "${RUNNER_TEMP}/helpers.sh"
Â  Â  Â  Â  Â  Â  mkdir -p "${OUTDIR}/out-main" "${OUTDIR}/out-d"
Â  Â  Â  Â  Â  Â  ( run_block "_main" "${OUTDIR}/out-main" ) & pid_main=$!
Â  Â  Â  Â  Â  Â  ( run_block "_d"Â  Â  "${OUTDIR}/out-d"Â  Â  ) & pid_d=$!
Â  Â  Â  Â  Â  Â  wait "$pid_main" || true; wait "$pid_d" || true
Â  Â  Â  Â  Â  Â  popd >/dev/null
Â  Â  Â  Â  Â  Â  echo "::endgroup::"

Â  Â  Â  Â  Â  Â  echo "::group::Merge"
Â  Â  Â  Â  Â  Â  python - << 'PY'
Â  Â  Â  Â  Â  Â  import os, glob, xml.etree.ElementTree as ET
Â  Â  Â  Â  Â  Â  gw, temp = os.environ["GITHUB_WORKSPACE"], os.environ["OUTDIR"]
Â  Â  Â  Â  Â  Â  def merge(mask, outp):
Â  Â  Â  Â  Â  Â  Â  Â  files = sorted(f for f in glob.glob(mask) if os.path.isfile(f) and os.path.getsize(f) > 0)
Â  Â  Â  Â  Â  Â  Â  Â  if not files:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  open(outp, "w", encoding="utf-8").write('<?xml version="1.0" encoding="UTF-8"?>\n<tv></tv>')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  Â  Â  Â  Â  t0 = ET.parse(files[0]); r0 = t0.getroot()
Â  Â  Â  Â  Â  Â  Â  Â  chs = set(c.get('id','') for c in r0.findall('channel'))
Â  Â  Â  Â  Â  Â  Â  Â  progs = set((p.get('channel',''), p.get('start','')) for p in r0.findall('programme'))
Â  Â  Â  Â  Â  Â  Â  Â  for pth in files[1:]:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r = ET.parse(pth).getroot()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  except:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for c in r.findall('channel'):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cid = c.get('id','')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if cid and cid not in chs:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r0.append(c)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chs.add(cid)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for pr in r.findall('programme'):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  k = (pr.get('channel',''), pr.get('start',''))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if k not in progs:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r0.append(pr)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progs.add(k)
Â  Â  Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ET.indent(t0, space="Â  ", level=0)
Â  Â  Â  Â  Â  Â  Â  Â  except:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pass
Â  Â  Â  Â  Â  Â  Â  Â  t0.write(outp, encoding="utf-8", xml_declaration=True)
Â  Â  Â  Â  Â  Â  merge(os.path.join(temp,"out-main","_main__*.xml"), os.path.join(gw,"m_epg.xml"))
Â  Â  Â  Â  Â  Â  merge(os.path.join(temp,"out-d","_d__*.xml"),Â  Â  Â  os.path.join(gw,"d_epg.xml"))
Â  Â  Â  Â  Â  Â  PY
Â  Â  Â  Â  Â  Â  echo "::endgroup::"

Â  Â  Â  Â  Â  Â  echo "m_epg.xml ->Â  $(grep -c '<channel' "${GITHUB_WORKSPACE}/m_epg.xml") channels"
Â  Â  Â  Â  Â  Â  echo "d_epg.xml ->Â  $(grep -c '<channel' "${GITHUB_WORKSPACE}/d_epg.xml") channels"

Â  Â  Â  Â  Â  Â  SITE="${OUTDIR}/site"
Â  Â  Â  Â  Â  Â  mkdir -p "$SITE"
Â  Â  Â  Â  Â  Â  cp "${GITHUB_WORKSPACE}/m_epg.xml" "${SITE}/"
Â  Â  Â  Â  Â  Â  cp "${GITHUB_WORKSPACE}/d_epg.xml" "${SITE}/"
Â  Â  Â  Â  Â  Â  [ -f "${GITHUB_WORKSPACE}/m_playlist.m3u8" ] && cp "${GITHUB_WORKSPACE}/m_playlist.m3u8" "${SITE}/"
Â  Â  Â  Â  Â  Â  [ -f "${GITHUB_WORKSPACE}/d_playlist.m3u8" ] && cp "${GITHUB_WORKSPACE}/d_playlist.m3u8" "${SITE}/"
Â  Â  Â  Â  Â  Â  echo "SITE=${SITE}" >> "$GITHUB_ENV"
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  printf '%s\n' "$PIPELINE" > "$RUNNER_TEMP/pipeline.sh"
Â  Â  Â  Â  Â  chmod +x "$RUNNER_TEMP/pipeline.sh"
Â  Â  Â  Â  Â  bash "$RUNNER_TEMP/pipeline.sh" 2>&1 | tee "$GITHUB_WORKSPACE/tv_epg.log"

Â  Â  Â  - name: Upload log artifact
Â  Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: tv-logs
Â  Â  Â  Â  Â  path: tv_epg.log
Â  Â  Â  Â  Â  if-no-files-found: warn
Â  Â  Â  Â  Â  retention-days: 7

Â  Â  Â  - name: Upload artifact to Pages
Â  Â  Â  Â  uses: actions/upload-pages-artifact@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: ${{ env.SITE }}

Â  deploy_epg:
Â  Â  if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
Â  Â  needs: build_epg
Â  Â  runs-on: ubuntu-latest
Â  Â  environment:
Â  Â  Â  name: github-pages
Â  Â  Â  url: ${{ steps.deployment.outputs.page_url }}
Â  Â  steps:
Â  Â  Â  - name: Deploy to GitHub Pages
Â  Â  Â  Â  id: deployment
Â  Â  Â  Â  uses: actions/deploy-pages@v4

Â  update_readme:
Â  Â  Â  if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
Â  Â  Â  needs: deploy_epg
Â  Â  Â  runs-on: ubuntu-latest
Â  Â  Â  permissions:
Â  Â  Â  Â  contents: write
Â Â 
Â  Â  Â  env:
Â  Â  Â  Â  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
Â  Â  Â  Â  RUN_EVENT: ${{ github.event_name }}
Â  Â  Â  Â  RUN_ID: ${{ github.run_id }}
Â  Â  Â  Â  GITHUB_TOKEN: ${{ github.token }}
Â  Â  Â  Â  DASH_COMMIT_MSG: 'EPG Updated! ðŸ“º'
Â  Â  Â  Â  TV_LOG: tv_epg.log
Â  Â  Â  Â Â 
Â  Â  Â  steps:
Â  Â  Â  Â  - name: Checkout
Â  Â  Â  Â  Â  uses: actions/checkout@v4
Â Â 
Â  Â  Â  Â  - name: Setup Python
Â  Â  Â  Â  Â  uses: actions/setup-python@v5
Â  Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  Â  python-version: '3.x'
Â Â 
Â  Â  Â  Â  - name: Install deps
Â  Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Â  pip install requests
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  - name: Download log artifact
Â  Â  Â  Â  Â  uses: actions/download-artifact@v4
Â  Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  Â  name: tv-logs
Â  Â  Â  Â  Â  Â  path: .
Â Â 
Â  Â  Â  Â  - name: Update README via dashboard.py (tv section only)
Â  Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Â  python dashboard.py tv --log "$TV_LOG"

Â  publish_assets:
Â  Â  if: ${{ github.event_name == 'push' }}
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: Checkout
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  - name: Prepare site (reuse existing EPG from Pages)
Â  Â  Â  Â  shell: bash
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  OUTDIR="${RUNNER_TEMP}/site"
Â  Â  Â  Â  Â  mkdir -p "$OUTDIR"
Â  Â  Â  Â  Â  curl -fsSL "https://dtvabrand.github.io/entertainment/m_epg.xml" -o "$OUTDIR/m_epg.xml" || true
Â  Â  Â  Â  Â  curl -fsSL "https://dtvabrand.github.io/entertainment/d_epg.xml" -o "$OUTDIR/d_epg.xml" || true
Â  Â  Â  Â  Â  [ -f "m_playlist.m3u8" ] && cp "m_playlist.m3u8" "$OUTDIR/"
Â  Â  Â  Â  Â  [ -f "d_playlist.m3u8" ] && cp "d_playlist.m3u8" "$OUTDIR/"
Â  Â  Â  Â  Â  echo "SITE=$OUTDIR" >> "$GITHUB_ENV"

Â  Â  Â  - name: Upload artifact to Pages
Â  Â  Â  Â  uses: actions/upload-pages-artifact@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: ${{ env.SITE }}

Â  deploy_assets:
Â  Â  if: ${{ github.event_name == 'push' }}
Â  Â  needs: publish_assets
Â  Â  runs-on: ubuntu-latest
Â  Â  environment:
Â  Â  Â  name: github-pages
Â  Â  Â  url: ${{ steps.deployment.outputs.page_url }}
Â  Â  steps:
Â  Â  Â  - name: Deploy to GitHub Pages
Â  Â  Â  Â  id: deployment
Â  Â  Â  Â  uses: actions/deploy-pages@v4
